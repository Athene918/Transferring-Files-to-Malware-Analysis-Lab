## Transferring-Files-to-Malware-Analysis-Lab

![image](https://miro.medium.com/v2/format:webp/1*y2R95D5XFs-TazlmVCv28g.png)

### Tsurugi Linux Static IP Assignment
Start the pfSense VM if it is shut down. Once pfSense is up and running. Start the Tsurugi Linux VM. One the terminal and run the following command:

````bash
ip addr
````

![image](https://miro.medium.com/v2/format:webp/1*sqkiveZI7DxyIyFqxyxKbA.png)

Tsurugi Linux has been assigned the IP Address **10.10.10.12** by the DHCP server.

Start the Kali Linux VM and log into the pfSense Web UI.

![image](https://miro.medium.com/v2/format:webp/1*ZEWxU0pR8gFsJ657hc4Ptw.png)

From the navigation bar select **Status -> DHCP Leases**.

![image](https://miro.medium.com/v2/format:webp/1*_KBO7uCVVU7XMkSwoFs-PQ.png)

In the **Leases** section find Tsurugi Linux. Click on the hollow "+" icon (Add Static IP) on the right-hand side.

![image](https://miro.medium.com/v2/format:webp/1*bYWC2mdQvTjl2BuwsMaFrA.png)

In the IP Address field enter **10.10.10.2**. Scroll to the bottom and click on **Save**.

![image](https://miro.medium.com/v2/format:webp/1*xRERWuJNRiMKfVqW96xvKQ.png)

A popup will appear at the top. Click on **Apply Changes**.

![image](https://miro.medium.com/v2/format:webp/1*iSEObwj5_H_ADWXUWsalGg.png)

### Refreshing Tsurugi Linux IP Address
On Tsurugi Linux from the terminal run the following command

````bash
# Disable and then Enable the Network Adapter
sudo ip l set enp0s3 down && sudo ip l set enp0s3 up
````

Restarting the adapter will cause the dynamic IP that was assigned to the VM to be released. Run the following command to confirm the VM is using the configured static IP.

````bash
ip a enp0s3
````

![image](https://miro.medium.com/v2/format:webp/1*IsyYNeHmniPjCU3sL5COTA.png)

Refresh the DHCP Leases page and we should see that Tsurugi Linux is now using the IP address that we configured.

![image](https://miro.medium.com/v2/format:webp/1*IUBYG-2qeLiFIjMMFwKaGQ.png)

### pfSense Firewall Configuration
From the navigation bar select **Firewall -> Rules**.

![image](https://miro.medium.com/v2/format:webp/1*V5s5e_X7HNSGwI_8UfKzuQ.png)

Go to the **ISOLATED** subnet tab. Click on the "Add rule to the top of the list" button.

![image](https://miro.medium.com/v2/format:webp/1*yj5_NK7ZutwD6a7iNfQAxQ.png)

Enter the details as shown below:
Source: ISOLATED subnets
Destination: **Address or Alias - 10.10.10.2**
Destination Port Range: **SSH (22)**
Description: **Allows SSH access to DFIR VM**

![image](https://miro.medium.com/v2/format:webp/1*4KU1J2UFzl1n1Ar26JnkiA.png)

A popup will appear at the top of the page. Click on **Apply Changes**

![image](https://miro.medium.com/v2/format:webp/1*vuNInn6wnQm_6qw4lRjzsA.png)

The final firewall rules will look as follows:

![image](https://miro.medium.com/v2/format:webp/1*C1hTn5H_chJLhlMuIsdaIA.png)

### Enabling SSH
### Tsurugi Linux
Run the following command to check if SSH is running.

````bash
systemctl status ssh
````

If SSH is disabled use the following command to enable it.

````bash
sudo systemctl start ssh
````

![image](https://miro.medium.com/v2/format:webp/1*dksT0ppW_fEeFUacVItMtw.png)

### Flare VM (Windows)
Right-click on the Start menu icon. Select **Windows PowerShell (Admin)**.

![image](https://miro.medium.com/v2/format:webp/1*fIiZX_mDV5zHudm6uf6DoQ.png)

Enter the following command to check if the SSH server is running.

````bash
Get-Service sshd
````

Run the following to enable the SSH server.

`````bash
Start-Service sshd
`````

![image](https://miro.medium.com/v2/format:webp/1*hlMv8CW6t34BpzfHeioy_Q.png)

### REMnux Linux
Running the following commands to check the status of SSH and enable it.

`````bash
# Check Status
systemctl status ssh

# Enable SSH
sudo systemctl start ssh
`````

![image](https://miro.medium.com/v2/format:webp/1*pKX-GNIXbNWttmDuEVrWcQ.png)

### Testing SSH Connectivity
## Finding Target VM IP Address
To connect to Flare VM and REMnux we need their IP address.

````powershell
ipconfig
````

![image](https://miro.medium.com/v2/format:webp/1*nyHr3LRDwGZVZuKIC32m_g.png)

````bash
ip addr
````

![image](https://miro.medium.com/v2/format:webp/1*dgTb7Qmgd7lczE4RrE4Kyw.png)

### Connecting to Flare VM
In my case, the IP address of Flare VM is **10.99.99.11**.

Use the following command to remote into Flare VM from Tsurugi Linux.

````bash
# ssh target-system-username@target-system-ip-address
ssh david@10.99.99.11
````

Type **yes** to add the fingerprint.
Enter the password of the target system when prompted.

![image](https://miro.medium.com/v2/format:webp/1*xiGJrkDXFitiXEcoJ0Lq0Q.png)

This will log you into Flare VM.

![image](https://miro.medium.com/v2/format:webp/1*JqIMa4F5Zd-2_9YHm5M6TQ.png)

Type **exit** to quit the remote connection.

### Connecting to REMnux Linux
In my case, the IP address for REMnux is **10.99.99.12**.

Use the following command to remote into REMnux from Tsurugi Linux.

````bash
# ssh target-system-username@target-system-ip-address
ssh remnux@10.99.99.12
````

Type **yes** to add the fingerprint.
Enter the password of the target system when prompted.

![image](https://miro.medium.com/v2/format:webp/1*2H0PZcZkdaBU7_GJL51zlg.png)

Type **exit** to quit the remote connection.

## SCP File Transfer
Now we know that we can connect to the Malware Analysis Lab VMs from Tsurugi Linux.

To demonstrate how to transfer files from Tsurugi Linux to the Malware Analysis Lab VMs I will use a simple text file. To follow along run the following commands on Tsurugi Linux:

````bash
cd Downloads
echo "Hello Hello World" > hello.txt
cat hello.txt
````

### File Transfer to Flare VM
To transfer **hello.txt** to the target systems we will use SCP which is can command line utility that uses SSH to securely copy files over the network.

Run the following command to copy the file to Flare VM.

````bash
# scp file-to-copy target-ysername@target-ip-address:destination-path
scp hello.txt david@10.99.99.11:/C:/Users/David/Downloads
````

![image](https://miro.medium.com/v2/format:webp/1*8KFc7d39PViR6z9bgAb7KA.png)

The above command will copy the file into the Downloads folder on Flare VM.

![image](https://miro.medium.com/v2/format:webp/1*61TlQwRA0zdXlkAAvb-zCw.png)

### File Transfer to REMnux Linux
Using the same command we can move the file onto REMnux as well.

````bash
# scp file-to-copy target-ysername@target-ip-address:destination-path
scp hello.txt remnux@10.99.99.12:~/Downloads
````

![image](https://miro.medium.com/v2/format:webp/1*-UMd3Tz2a111G6uAt9ySrQ.png)

The above command will copy the file into the Downloads folder on REMnux.

![image](https://miro.medium.com/v2/format:webp/1*QX1_hOVqbesXBOoaXST36Q.png)

> To copy a whole folder use the **-r** (recursive) flag with the SCP command
> [SCP Linux - Securely Copy Files Using SCP examples](https://linuxblog.io/linux-securely-copy-files-using-scp/)

### Disabling SSH
Once you copy the required files onto the Malware Analysis lab use the following commands to disable SSH on all the systems.

### Tsurugi Linux

````bash
sudo systemctl stop ssh
````

![image](https://miro.medium.com/v2/format:webp/1*qUMngmRJvYsyWi40W24pPA.png)

## Flare VM (Windows)

````powershell
Stop-Service sshd
````

![image](https://miro.medium.com/v2/format:webp/1*Mg9k_vl2KI6EczC_v-qewg.png)

### REMnux Linux

````bash
sudo systemctl stop ssh
````

![image](https://miro.medium.com/v2/format:webp/1*kmzFmx-hbJfY0N4fzpLcwQ.png)


